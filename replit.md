# AI Чат с Kandinsky 3.0

## Обзор проекта
Веб-приложение AI-чата с интеграцией российских AI-сервисов:
- **GigaChat** для генерации текстовых ответов
- **Kandinsky 3.0** для генерации изображений по текстовым описаниям
- **Поиск в интернете** через DuckDuckGo и Wikipedia

## Архитектура

### Основные компоненты:
- **app.py** - основное Flask приложение
- **gigachat_model.py** - интеграция с GigaChat API и координация с Kandinsky
- **kandinsky_service.py** - интеграция с Kandinsky 3.0 API через Fusion Brain
- **search_service.py** - сервис поиска в интернете

### Логика работы:
1. **Все запросы** сначала поступают в **GigaChat** (единая точка входа)
2. GigaChat анализирует запрос с помощью системного промпта и решает:
   - Если нужно изображение → отвечает "ГЕНЕРИРУЮ_ИЗОБРАЖЕНИЕ: [описание]" → вызывается **Kandinsky 3.0**
   - Если нужен поиск → использует **SearchService** и включает результаты в ответ
   - Иначе → генерирует обычный текстовый ответ
3. **Нет прямой проверки ключевых слов** - только через анализ ответа GigaChat

### Технологический стек:
- **Backend**: Python 3.11, Flask, Gunicorn
- **Frontend**: Bootstrap 5, JavaScript
- **AI Services**: GigaChat API, Kandinsky 3.0 API
- **Database**: SQLAlchemy (настроена, но пока не используется)

## API Конфигурация

### Kandinsky 3.0 (Fusion Brain):
- **API Key**: Загружается из переменной окружения `KANDINSKY_API_KEY`
- **Secret Key**: Загружается из переменной окружения `KANDINSKY_SECRET_KEY`
- **Endpoint**: https://api-key.fusionbrain.ai/
- **Модель**: Kandinsky Split 3.0 v3.0
- **Лимиты**: 20 изображений бесплатно
- **Безопасность**: Ключи хранятся в Replit Secrets

### GigaChat:
- Токен получается автоматически через OAuth
- Поддержка контекста и истории чата
- Интеграция с поиском в интернете

## Функции генерации изображений

### Команды для пользователей:
- `нарисуй [описание]`
- `создай изображение [описание]`
- `сгенерируй изображение [описание]`
- `/generate [описание]`

### Технические особенности:
- Размеры: до 1024x1024 пикселей
- Соотношения сторон: 1:1, 2:3, 3:2, 9:16, 16:9
- Максимальная длина промпта: 1000 символов
- Поддержка негативных промптов
- Модерация контента

## API Endpoints

### Основные:
- `GET /` - главная страница чата
- `POST /api/chat` - отправка сообщений
- `POST /api/clear` - очистка истории
- `GET /api/history` - получение истории

### Статус сервисов:
- `GET /api/model_status` - статус GigaChat
- `GET /api/image_status` - статус сервисов генерации изображений
- `GET /api/kandinsky/styles` - доступные стили Kandinsky

## Последние изменения

### 12 августа 2025:
- ✅ Интегрирован Kandinsky 3.0 API
- ✅ Создан KandinskyService с полной функциональностью
- ✅ Обновлен интерфейс для показа Kandinsky 3.0
- ✅ Добавлены новые API endpoints
- ✅ Исправлена ошибка 404 с проверкой доступности сервиса
- ✅ Настроена генерация изображений в формате base64
- ✅ Удален SeaArtService - оставлен только Kandinsky
- ✅ Упрощена архитектура генерации изображений
- ✅ Исправлено отображение изображений в веб-интерфейсе
- ✅ Подтверждена работоспособность Kandinsky 3.0
- ✅ Настроена интеграция: GigaChat → Kandinsky (вместо параллельной работы)
- ✅ GigaChat теперь координирует генерацию изображений
- ✅ Исправлена логика: убрана прямая проверка ключевых слов
- ✅ Все запросы идут через GigaChat как единую точку входа
- ✅ Добавлен маркер "ГЕНЕРИРУЮ_ИЗОБРАЖЕНИЕ:" для четкого управления
- ✅ GigaChat теперь различает запросы на совет и конкретные запросы на создание
- ✅ Система работает в режиме: сначала советчик, потом исполнитель
- ✅ Исправлена проблема с преждевременной генерацией изображений
- ✅ **ПЕРЕДЕЛАНА АРХИТЕКТУРА ПОИСКА**: теперь работает через GigaChat
- ✅ Добавлен маркер "ИЩУИНФОРМАЦИЮ:" для контроля поиска
- ✅ Интегрирована библиотека duckduckgo-search для стабильного поиска
- ✅ Убраны все fallback механизмы - поиск работает напрямую
- ✅ Улучшен системный промпт для распознавания запросов на актуальную информацию
- ✅ **ИСПРАВЛЕНА ПРОБЛЕМА RATE LIMITING**: добавлена задержка между запросами к GigaChat
- ✅ Подтверждено: система работает полностью - GigaChat распознает запросы и делает поиск
- ✅ **РЕАЛИЗОВАН ПОЛНОЦЕННЫЙ СЕМАНТИЧЕСКИЙ АНАЛИЗ**: 
  - GigaChat теперь самостоятельно переводит ЛЮБЫЕ русские термины в английские
  - Убрана ограниченная словарная система перевода
  - Система понимает: "искусственный интеллект" → "artificial intelligence"
  - "машинное обучение" → "machine learning", "квантовые компьютеры" → "quantum computers"
  - Работает для всех технических терминов без предварительного программирования

### Статус:
- GigaChat: ✅ Работает (с защитой от rate limiting)
- Kandinsky 3.0: ✅ Работает и генерирует изображения
- Веб-интерфейс: ✅ Отображает изображения в чате
- Поиск: ✅ Работает полностью (GigaChat → DuckDuckGo → ответ)

## Конфигурация запуска

### Команда запуска:
```bash
gunicorn --bind 0.0.0.0:5000 --reuse-port --reload main:app
```

### Переменные окружения:
- `SESSION_SECRET` - секретный ключ сессии
- `DATABASE_URL` - URL базы данных (настроена, но не используется)
- `KANDINSKY_API_KEY` - API ключ для Kandinsky 3.0
- `KANDINSKY_SECRET_KEY` - секретный ключ для Kandinsky 3.0

## Пользовательские предпочтения
- Язык интерфейса: Русский
- Стиль ответов: Профессиональный, без эмодзи
- Фокус на функциональности российских AI-сервисов